import org.openapitools.generator.gradle.plugin.tasks.GenerateTask

plugins {
	id 'java'
	id 'org.springframework.boot' version '2.7.8'
	id 'io.spring.dependency-management' version '1.1.0'
	id 'org.openapi.generator' version '6.0.0'
}

group = 'market.habba'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

configurations {
	compileOnly {
		extendsFrom annotationProcessor
	}
}

repositories {
	mavenCentral()
	mavenLocal()
}



dependencies {
	implementation "org.projectlombok:lombok:1.18.12"

	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation "org.flywaydb:flyway-core"
	// https://mvnrepository.com/artifact/io.jsonwebtoken/jjwt
	implementation group: 'io.jsonwebtoken', name: 'jjwt', version: '0.9.1'

	// ----------- Open-Api dependencies ----------- //
	implementation "org.openapitools:openapi-generator-gradle-plugin:6.0.0"
	implementation 'org.springdoc:springdoc-openapi-ui:1.6.11'
	// https://mvnrepository.com/artifact/org.openapitools/jackson-databind-nullable
	implementation group: 'org.openapitools', name: 'jackson-databind-nullable', version: '0.2.0'
// https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-mail
	implementation group: 'org.springframework.boot', name: 'spring-boot-starter-mail', version: '2.6.3'

// https://mvnrepository.com/artifact/org.slf4j/slf4j-api
//	implementation group: 'org.slf4j', name: 'slf4j-api', version: '2.0.6'
//
	configurations {
		all*.exclude module : 'spring-boot-starter-logging'
	}

	annotationProcessor "org.mapstruct:mapstruct:1.3.1.Final"
	annotationProcessor "org.mapstruct:mapstruct-processor:1.3.1.Final"

//	implementation 'org.mapstruct:mapstruct:1.5.3.Final'
//	annotationProcessor 'org.mapstruct:mapstruct-processor:1.5.3.Final'

//	implementation "org.mapstruct:mapstruct:1.5.3.Final"
//	testImplementation "org.testng:testng:6.10", "org.easytesting:fest-assert:1.4"
//	annotationProcessor "org.mapstruct:mapstruct-processor:1.5.3.Final"

//	compileOnly 'org.projectlombok:lombok'
	runtimeOnly 'org.postgresql:postgresql'
	annotationProcessor 'org.projectlombok:lombok:1.18.12'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.security:spring-security-test'
}

tasks.named('test') {
	useJUnitPlatform()
}

sourceSets {
	main {
		java {
			srcDir "$buildDir/generated/src/main/java"
		}
	}
}

//генерация кода
file('config/').listFiles().each {
	def apiName = it.getName().replace(".yaml", "");
	def task = tasks.create("openApiGenerate" + apiName.capitalize(), GenerateTask.class, {
		generatorName = "spring"
		inputSpec = "$rootDir/config/market_habba_v0.yaml"
		outputDir = "$buildDir/generated"
		apiPackage = "market.habba.api"
		modelPackage = "market.habba.model"
		enablePostProcessFile = true
		skipOverwrite = false
		configOptions = [
				dateLibrary         : "java8",
				bigDecimalAsString  : "true",
				interfaceOnly       : "true",
				skipDefaultInterface: "true",
				useTags             : "true",
				useLombok           : "true"
		]
	})
	compileJava.dependsOn task
}
